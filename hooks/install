#!/bin/bash
# Here do anything needed to install the service
# i.e. apt-get install -y foo  or  bzr branch http://myserver/mycode /srv/webroot
# Make sure this hook exits cleanly and is idempotent, common problems here are failing to account for a debconf question on a dependency, or trying to pull from github without installing git first.
set -eux # -x for verbose logging to juju debug-log
HOME=$PWD
CHECKSUM="8614d80e8afdb9d936e8574b24e9b405"
HOST=`unit-get private-address`

juju-log "install dependency"
apt-get install -y curl wget git nginx

juju-log "download kibana from elasticsearch.org"
wget -q -O /tmp/kibana-latest.tgz https://download.elasticsearch.org/kibana/kibana/kibana-latest.tar.gz

install -o root -g root -m 0644 files/charm/nginx.conf /etc/nginx/sites-available/kibana
install -o root -g root -m 0644 files/charm/nginx_lb.conf /etc/nginx/sites-available/es_cluster

pushd /usr/share

tar xzvf /tmp/kibana-latest.tgz

mv kibana-latest kibana3

rm -f /etc/nginx/sites-enabled/default

popd

rm -f /usr/share/kibana3/config.js
install -o root -g root -m 0644 files/charm/config.js /usr/share/kibana3/config.js


ln -s /etc/nginx/sites-available/kibana /etc/nginx/sites-enabled/kibana
ln -s /etc/nginx/sites-available/es_cluster /etc/nginx/sites-enabled/es_cluster

service nginx restart
